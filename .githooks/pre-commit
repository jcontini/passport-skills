#!/bin/bash
#
# Pre-commit hook for agentos-plugins
# Blocks commits that contain security vulnerabilities
#
# Install: git config core.hooksPath .githooks
#

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "ğŸ”’ Running security checks..."

# Get list of staged files (only plugin markdown files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ“ No plugin files to check${NC}"
    exit 0
fi

ERRORS=0

# Check 1: AUTH_TOKEN exposure
# This catches shell scripts that expose credentials via environment variables
echo "  Checking for credential exposure..."
AUTH_TOKEN_FILES=$(echo "$STAGED_FILES" | xargs grep -l '\$AUTH_TOKEN\|\${AUTH_TOKEN}' 2>/dev/null || true)
if [ -n "$AUTH_TOKEN_FILES" ]; then
    echo -e "${RED}âœ— BLOCKED: \$AUTH_TOKEN found in:${NC}"
    echo "$AUTH_TOKEN_FILES" | sed 's/^/    /'
    echo ""
    echo -e "${YELLOW}  Fix: Use rest: or graphql: blocks instead of run: scripts${NC}"
    echo "  AgentOS injects credentials automatically - plugins should never see them"
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# Check 2: Direct curl usage with Authorization headers
# This catches attempts to manually make authenticated API calls
echo "  Checking for direct curl with auth..."
CURL_AUTH_FILES=$(echo "$STAGED_FILES" | xargs grep -l 'curl.*-H.*[Aa]uthorization\|curl.*--header.*[Aa]uthorization' 2>/dev/null || true)
if [ -n "$CURL_AUTH_FILES" ]; then
    echo -e "${RED}âœ— BLOCKED: curl with Authorization header found in:${NC}"
    echo "$CURL_AUTH_FILES" | sed 's/^/    /'
    echo ""
    echo -e "${YELLOW}  Fix: Use rest: blocks - AgentOS handles authentication${NC}"
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# Check 3: Direct curl usage with x-api-key headers
echo "  Checking for direct curl with API keys..."
CURL_APIKEY_FILES=$(echo "$STAGED_FILES" | xargs grep -l 'curl.*-H.*[Xx]-[Aa]pi-[Kk]ey\|curl.*--header.*[Xx]-[Aa]pi-[Kk]ey' 2>/dev/null || true)
if [ -n "$CURL_APIKEY_FILES" ]; then
    echo -e "${RED}âœ— BLOCKED: curl with x-api-key header found in:${NC}"
    echo "$CURL_APIKEY_FILES" | sed 's/^/    /'
    echo ""
    echo -e "${YELLOW}  Fix: Use rest: blocks - AgentOS handles authentication${NC}"
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# Check 4: Bearer token patterns in scripts
echo "  Checking for Bearer token patterns..."
BEARER_FILES=$(echo "$STAGED_FILES" | xargs grep -l 'Bearer \$\|Bearer "\$\|Bearer '"'"'\$' 2>/dev/null || true)
if [ -n "$BEARER_FILES" ]; then
    echo -e "${RED}âœ— BLOCKED: Bearer token interpolation found in:${NC}"
    echo "$BEARER_FILES" | sed 's/^/    /'
    echo ""
    echo -e "${YELLOW}  Fix: Use rest: blocks with auth: configuration${NC}"
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# Check 5: run: blocks that make HTTP requests (should use rest: instead)
echo "  Checking for run: blocks with HTTP requests..."
RUN_HTTP_FILES=$(echo "$STAGED_FILES" | xargs grep -l 'run:.*curl\|run:.*wget\|run:.*http' 2>/dev/null || true)
# More thorough check - look for run: followed by curl within the same action block
for file in $STAGED_FILES; do
    if grep -q 'run: |' "$file" 2>/dev/null; then
        # Check if curl appears in run blocks (not in comments or docs)
        if awk '/run: \|/,/^  [a-z]/' "$file" 2>/dev/null | grep -q 'curl '; then
            if [ -z "$RUN_HTTP_FILES" ] || ! echo "$RUN_HTTP_FILES" | grep -q "$file"; then
                RUN_HTTP_FILES="$RUN_HTTP_FILES $file"
            fi
        fi
    fi
done
RUN_HTTP_FILES=$(echo "$RUN_HTTP_FILES" | xargs)  # trim whitespace
if [ -n "$RUN_HTTP_FILES" ]; then
    echo -e "${RED}âœ— BLOCKED: run: block with curl/wget found in:${NC}"
    echo "$RUN_HTTP_FILES" | tr ' ' '\n' | sed 's/^/    /'
    echo ""
    echo -e "${YELLOW}  Fix: Convert to rest: or graphql: blocks${NC}"
    echo "  run: blocks should only be used for local operations (no network calls)"
    echo ""
    ERRORS=$((ERRORS + 1))
fi

# Summary
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}  COMMIT BLOCKED: $ERRORS security issue(s) found${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "  Plugins must use AgentOS secure executors:"
    echo "    â€¢ rest:     for REST API calls"
    echo "    â€¢ graphql:  for GraphQL API calls"
    echo "    â€¢ run:      ONLY for local operations (no network, no credentials)"
    echo ""
    echo "  See: https://github.com/agentos/agentos-plugins/blob/main/CONTRIBUTING.md"
    echo ""
    exit 1
else
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}  âœ“ All security checks passed${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
fi
